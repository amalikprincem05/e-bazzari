<div class="py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg border-0">
          <div class="card-body p-5">
            <div class="text-center mb-4">
              <i class="fas fa-user-edit fa-4x text-primary mb-3"></i>
              <h2 class="fw-bold text-dark">Edit Profile</h2>
              <p class="text-muted">Update your account information</p>
            </div>

            <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, class: "needs-validation", novalidate: true }) do |f| %>
              <%= render "devise/shared/error_messages", resource: resource %>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= f.label :first_name, class: "form-label fw-semibold" do %>
                    <i class="fas fa-user me-2 text-primary"></i>First Name
                  <% end %>
                  <%= f.text_field :first_name, autofocus: true, 
                      class: "form-control form-control-lg", placeholder: "Enter your first name", required: true %>
                  <div class="invalid-feedback">
                    Please provide your first name.
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <%= f.label :last_name, class: "form-label fw-semibold" do %>
                    <i class="fas fa-user me-2 text-primary"></i>Last Name
                  <% end %>
                  <%= f.text_field :last_name, 
                      class: "form-control form-control-lg", placeholder: "Enter your last name", required: true %>
                  <div class="invalid-feedback">
                    Please provide your last name.
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <%= f.label :email, class: "form-label fw-semibold" do %>
                  <i class="fas fa-envelope me-2 text-primary"></i>Email Address
                <% end %>
                <%= f.email_field :email, autocomplete: "email", 
                    class: "form-control form-control-lg", placeholder: "Enter your email address", required: true %>
                <div class="invalid-feedback">
                  Please provide a valid email address.
                </div>
                <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
                  <div class="alert alert-warning mt-2">
                    <small>Currently waiting confirmation for: <%= resource.unconfirmed_email %></small>
                  </div>
                <% end %>
              </div>

              <div class="mb-3">
                <%= f.label :phone, class: "form-label fw-semibold" do %>
                  <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                <% end %>
                <%= f.telephone_field :phone, 
                    class: "form-control form-control-lg", placeholder: "Enter your phone number", required: true %>
              </div>

              <div class="mb-3">
                <%= f.label :cnic, class: "form-label fw-semibold" do %>
                  <i class="fas fa-id-card me-2 text-primary"></i>CNIC
                <% end %>
                <%= f.text_field :cnic,
                    class: "form-control form-control-lg",
                    placeholder: "Enter your 13-digit CNIC without dashes",
                    maxlength: 13,
                    minlength: 13,
                    required: true %>
              </div>

              <div class="mb-3">
                <%= f.label :address, class: "form-label fw-semibold" do %>
                  <i class="fas fa-map-marker-alt me-2 text-primary"></i>Address
                <% end %>
                <%= f.text_area :address, rows: 3,
                    class: "form-control form-control-lg", placeholder: "Enter your address" %>
              </div>

              <div class="card bg-light border-0 mb-4">
                <div class="card-body">
                  <h5 class="mb-3"><i class="fas fa-gift me-2 text-primary"></i>Your Referral Rewards</h5>
                  <p class="mb-2">
                    Share this code with friends to earn points:
                    <code class="fw-bold"><%= resource.referral_code %></code>
                  </p>
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" value="<%= request.base_url %>?ref=<%= resource.referral_code %>" readonly id="referral-share-link">
                    <button class="btn btn-outline-primary" type="button" id="copy-referral-link">Copy</button>
                  </div>
                  <p class="mb-0 text-muted">
                    Current Points:
                    <span class="badge bg-success"><%= resource.points %></span>
                  </p>
                </div>
              </div>

              <hr class="my-4">
              <h5 class="text-muted mb-3">Change Password</h5>

              <div class="mb-3">
                <%= f.label :password, class: "form-label fw-semibold" do %>
                  <i class="fas fa-lock me-2 text-primary"></i>New Password
                  <small class="text-muted">(leave blank if you don't want to change it)</small>
                <% end %>
                <%= f.password_field :password, autocomplete: "new-password", 
                    class: "form-control form-control-lg", placeholder: "Enter new password" %>
                <% if @minimum_password_length %>
                  <small class="text-muted"><%= @minimum_password_length %> characters minimum</small>
                <% end %>
              </div>

              <div class="mb-3">
                <%= f.label :password_confirmation, class: "form-label fw-semibold" do %>
                  <i class="fas fa-lock me-2 text-primary"></i>Confirm New Password
                <% end %>
                <%= f.password_field :password_confirmation, autocomplete: "new-password", 
                    class: "form-control form-control-lg", placeholder: "Confirm new password" %>
              </div>

              <div class="mb-4">
                <%= f.label :current_password, class: "form-label fw-semibold" do %>
                  <i class="fas fa-key me-2 text-primary"></i>Current Password
                  <small class="text-muted">(we need your current password to confirm your changes)</small>
                <% end %>
                <%= f.password_field :current_password, autocomplete: "current-password", 
                    class: "form-control form-control-lg", placeholder: "Enter current password", required: true %>
                <div class="invalid-feedback">
                  Please provide your current password.
                </div>
              </div>

              <div class="d-grid mb-4">
                <%= f.submit "Update Profile", class: "btn btn-primary btn-lg fw-semibold" %>
              </div>
            <% end %>

            <hr class="my-4">

            <div class="text-center">
              <h5 class="text-danger mb-3">Danger Zone</h5>
              <p class="text-muted mb-3">Once you delete your account, there is no going back. Please be certain.</p>
              <%= button_to "Delete Account", registration_path(resource_name), 
                  method: :delete, 
                  data: { confirm: "Are you sure? This action cannot be undone.", turbo_confirm: "Are you sure? This action cannot be undone." },
                  class: "btn btn-outline-danger btn-lg" %>
            </div>

            <div class="text-center mt-4">
              <%= link_to "â† Back to Dashboard", root_path, class: "btn btn-outline-secondary" %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Bootstrap form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var copyButton = document.getElementById('copy-referral-link');
  var referralLink = document.getElementById('referral-share-link');

  if (copyButton && referralLink) {
    copyButton.addEventListener('click', function() {
      referralLink.select();
      referralLink.setSelectionRange(0, referralLink.value.length);
      document.execCommand('copy');
      copyButton.classList.remove('btn-outline-primary');
      copyButton.classList.add('btn-success');
      copyButton.textContent = 'Copied!';
      setTimeout(function() {
        copyButton.classList.add('btn-outline-primary');
        copyButton.classList.remove('btn-success');
        copyButton.textContent = 'Copy';
      }, 2000);
    });
  }
});
</script>
