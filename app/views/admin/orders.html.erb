<div class="py-5">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="fas fa-shopping-bag me-2"></i>Manage Orders</h1>
      <div>
        <%= link_to "Dashboard", admin_dashboard_path, class: "btn btn-outline-secondary" %>
        <%= link_to "Manage Products", admin_products_path, class: "btn btn-outline-primary" %>
      </div>
    </div>

    <!-- User Search Form -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-search me-2"></i>Search Orders by User</h5>
        <%= form_with url: admin_orders_path, method: :get, local: true, class: "row g-3" do |form| %>
          <div class="col-md-8">
            <%= form.text_field :user_search, 
                value: params[:user_search], 
                placeholder: "Enter User ID (e.g., 1) or Email (e.g., user@example.com)", 
                class: "form-control" %>
          </div>
          <div class="col-md-4">
            <%= form.submit "Search Orders", class: "btn btn-primary me-2" %>
            <%= link_to "Show All", admin_orders_path, class: "btn btn-outline-secondary" %>
          </div>
        <% end %>
        
        <% if @searched_user %>
          <div class="mt-3">
            <div class="alert alert-info">
              <strong>Search Results for:</strong> <%= @searched_user.full_name %> (<%= @searched_user.email %>)
              <br>
              <small>Found <%= @orders.count %> order(s)</small>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <% if @orders.any? %>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Items</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @orders.each do |order| %>
                  <tr>
                    <td>
                      <strong>#<%= order.id %></strong>
                      <% if order.stripe_payment_intent_id.present? %>
                        <br>
                        <small class="text-muted">Stripe: <%= order.stripe_payment_intent_id[0..10] %>...</small>
                      <% end %>
                    </td>
                    <td><%= order.user.full_name %></td>
                    <td><%= order.user.email %></td>
                    <td><strong>$<%= order.total_amount %></strong></td>
                    <td>
                      <span class="badge bg-<%= case order.status
                        when 'pending' then 'warning'
                        when 'paid' then 'success'
                        when 'shipped' then 'info'
                        when 'delivered' then 'success'
                        when 'cancelled' then 'danger'
                        else 'secondary'
                      end %>">
                        <%= order.status.titleize %>
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-primary"><%= order.order_items.count %> items</span>
                    </td>
                    <td>
                      <%= order.created_at.strftime("%m/%d/%Y") %>
                      <br>
                      <small class="text-muted"><%= order.created_at.strftime("%I:%M %p") %></small>
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <%= link_to "View", order_path(order), class: "btn btn-sm btn-outline-primary" %>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Status
                          </button>
                          <ul class="dropdown-menu">
                            <li>
                              <%= button_to "Mark as Paid",
                                            admin_update_order_status_path(order),
                                            params: { status: "paid" },
                                            method: :patch,
                                            class: "dropdown-item w-100 text-start border-0 bg-transparent",
                                            data: { turbo_confirm: "Are you sure you want to mark this order as paid?" },
                                            form: { class: "dropdown-button-to" } %>
                            </li>
                            <li>
                              <%= button_to "Mark as Shipped",
                                            admin_update_order_status_path(order),
                                            params: { status: "shipped" },
                                            method: :patch,
                                            class: "dropdown-item w-100 text-start border-0 bg-transparent",
                                            data: { turbo_confirm: "Are you sure you want to mark this order as shipped?" },
                                            form: { class: "dropdown-button-to" } %>
                            </li>
                            <li>
                              <%= button_to "Mark as Delivered",
                                            admin_update_order_status_path(order),
                                            params: { status: "delivered" },
                                            method: :patch,
                                            class: "dropdown-item w-100 text-start border-0 bg-transparent",
                                            data: { turbo_confirm: "Are you sure you want to mark this order as delivered?" },
                                            form: { class: "dropdown-button-to" } %>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <%= button_to "Cancel Order",
                                            admin_update_order_status_path(order),
                                            params: { status: "cancelled" },
                                            method: :patch,
                                            class: "dropdown-item text-danger w-100 text-start border-0 bg-transparent",
                                            data: { turbo_confirm: "Are you sure you want to cancel this order?" },
                                            form: { class: "dropdown-button-to" } %>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          
          <!-- Order Statistics -->
          <div class="row mt-4">
            <div class="col-md-3">
              <div class="card bg-primary text-white">
                <div class="card-body text-center">
                  <h4><%= @orders.count %></h4>
                  <p class="mb-0">Total Orders</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success text-white">
                <div class="card-body text-center">
                  <h4><%= @orders.where(status: 'paid').count %></h4>
                  <p class="mb-0">Paid Orders</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-warning text-white">
                <div class="card-body text-center">
                  <h4><%= @orders.where(status: 'pending').count %></h4>
                  <p class="mb-0">Pending Orders</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white">
                <div class="card-body text-center">
                  <h4>$<%= @orders.sum(:total_amount) %></h4>
                  <p class="mb-0">Total Revenue</p>
                </div>
              </div>
            </div>
          </div>
        <% else %>
          <div class="text-center py-5">
            <i class="fas fa-shopping-bag fa-5x text-muted mb-3"></i>
            <h3>No orders yet</h3>
            <p class="text-muted">Orders will appear here once customers start making purchases.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
