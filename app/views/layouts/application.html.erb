<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "E Bazzari" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

  <link rel="manifest" href="/manifest.json">
  
 <link rel="icon" type="image/png" sizes="32x32" href="<%= asset_path('logo.png') %>">
<link rel="icon" type="image/png" sizes="16x16" href="<%= asset_path('logo.png') %>">
<link rel="apple-touch-icon" href="<%= asset_path('logo.png') %>">

    <style>
      .voice-overlay {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 1080;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.9rem 1.1rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        color: #fff;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
      }
      .voice-overlay.d-none {
        opacity: 0;
        transform: translateY(10px);
      }
      .voice-overlay .pulse {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #facc15;
        position: relative;
        animation: voice-pulse 1.2s infinite ease-in-out;
      }
      @keyframes voice-pulse {
        0% { transform: scale(0.9); opacity: 0.7; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.9); opacity: 0.7; }
      }
    </style>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      window.stripePublishableKey = '<%= ENV["STRIPE_PUBLISHABLE_KEY"] %>';
    </script>
    
   <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

  </head>

  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <div class="d-flex align-items-center w-100 gap-3">
          <%= link_to root_path, class: "navbar-brand d-flex align-items-center gap-2 fw-bold mb-0" do %>
            <%= image_tag "/assets/logo.png", alt: "ES Bazzari logo", height: 44, class: "object-fit-contain" %>

            <span>E-Bazzari</span>
          <% end %>
          <div class="flex-grow-1 d-none d-lg-block">
            <%= render "shared/global_search", input_id: "global-search-input-desktop", classes: "border-0" %>
          </div>
          <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
        
        <div class="collapse navbar-collapse mt-3 mt-lg-0" id="navbarNav">
          <div class="d-lg-none mb-3">
            <%= render "shared/global_search", input_id: "global-search-input-mobile", classes: "border-0" %>
          </div>
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <%= link_to "Home", root_path, class: "nav-link" %>
            </li>
            <li class="nav-item">
              <%= link_to "Shop", shop_path, class: "nav-link" %>
            </li>
            <li class="nav-item">
              <%= link_to "About", about_path, class: "nav-link" %>
            </li>
            <li class="nav-item">
              <%= link_to "Contact", contact_path, class: "nav-link" %>
            </li>
          </ul>
          
          <ul class="navbar-nav">
            <% if user_signed_in? %>
              <li class="nav-item">
                <%= link_to cart_path, class: "nav-link" do %>
                  <i class="fas fa-shopping-cart"></i> Cart
                  <% if current_user.cart_items.any? %>
                    <span class="badge bg-danger"><%= current_user.cart_items.sum(:quantity) %></span>
                  <% end %>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to "Orders", orders_path, class: "nav-link" %>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                  <%= current_user.full_name %>
                </a>
                <ul class="dropdown-menu">
                  <li><%= link_to "Profile", edit_user_registration_path, class: "dropdown-item" %></li>
                  <% if current_user.admin? %>
                    <li><hr class="dropdown-divider"></li>
                    <% if current_user.super_admin? %>
                      <li><%= link_to "Super Admin Panel", super_admin_dashboard_path, class: "dropdown-item text-warning" %></li>
                    <% end %>
                    <li><%= link_to "Admin Dashboard", admin_dashboard_path, class: "dropdown-item" %></li>
                    <li><%= link_to "Manage Products", admin_products_path, class: "dropdown-item" %></li>
                    <li><%= link_to "View Orders", admin_orders_path, class: "dropdown-item" %></li>
                    <li><%= link_to "Manage Users", admin_users_path, class: "dropdown-item" %></li>
                  <% end %>
                  <li><hr class="dropdown-divider"></li>
                  <li><%= button_to "Logout", destroy_user_session_path, method: :delete, class: "dropdown-item btn btn-link text-start w-100", local: true %></li>
                </ul>
              </li>
            <% else %>
              <li class="nav-item">
                <%= link_to "Login", new_user_session_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= link_to "Sign Up", new_user_registration_path, class: "nav-link" %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    <% if notice %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= notice %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= alert %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% end %>

    <!-- Main Content -->
    <main>
      <%= yield %>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>E-Bazzari</h5>
            <p>Your trusted online shopping destination</p>
          </div>
          <div class="col-md-6 text-md-end">
            <p>&copy; 2025 E-Bazzari. All rights reserved.</p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <%= javascript_importmap_tags %>

    <script>
      (function() {
        var voiceInitDone = false;

        function initVoiceSearch() {
          if (voiceInitDone) { return; }
          var voiceButtons = document.querySelectorAll('[data-voice-search]');
          if (!voiceButtons.length) { return; }

          var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
            voiceButtons.forEach(function(btn) { btn.classList.add('d-none'); });
            return;
          }

          var overlay = null;
          var overlayHideTimeout = null;

          function ensureOverlay() {
            if (overlay) { return overlay; }
            overlay = document.createElement('div');
            overlay.id = 'voice-overlay';
            overlay.className = 'voice-overlay d-none';
            overlay.setAttribute('role', 'status');
            overlay.setAttribute('aria-live', 'polite');
            overlay.innerHTML = '<div class="pulse"></div><i class="fas fa-microphone"></i><span>Listening...</span>';
            document.body.appendChild(overlay);
            return overlay;
          }

          function showOverlay(message) {
            ensureOverlay();
            overlay.querySelector('span').textContent = message;
            overlay.classList.remove('d-none');
          }
          function hideOverlay(delay) {
            ensureOverlay();
            if (overlayHideTimeout) { clearTimeout(overlayHideTimeout); }
            overlayHideTimeout = setTimeout(function() {
              overlay.classList.add('d-none');
            }, delay || 0);
          }

          var recognition;
          var activeButton = null;
          var activeInput = null;
          var pendingTranscript = '';

          function ensureRecognition() {
            if (recognition) { return recognition; }
            recognition = new SpeechRecognition();
              recognition.lang = 'ur-PK';
              recognition.interimResults = true;
              recognition.maxAlternatives = 3;
              recognition.continuous = true;

            recognition.addEventListener('start', function() {
              pendingTranscript = '';
            });

            recognition.addEventListener('result', function(event) {
              var transcriptChunk = '';
              for (var i = event.resultIndex; i < event.results.length; i++) {
                transcriptChunk += event.results[i][0].transcript;
              }

              if (transcriptChunk.trim().length) {
                pendingTranscript = transcriptChunk.trim();
                showOverlay('Listening…');
                if (activeInput) {
                  activeInput.value = pendingTranscript;
                  activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
              }
            });

            recognition.addEventListener('speechend', function() {
              recognition.stop();
            });

            recognition.addEventListener('error', function(evt) {
              console.error('Voice search error', evt.error);
              var message = evt.error === 'not-allowed'
                ? 'Mic blocked. براہ مہربانی اجازت دیں'
                : 'Speech not detected. دوبارہ کوشش کریں';
              showOverlay(message);
              hideOverlay(1000);
            });

            recognition.addEventListener('end', function() {
              var finalTranscript = pendingTranscript.trim();
              if (finalTranscript && activeInput) {
                showOverlay('Searching…');
                activeInput.value = finalTranscript;
                activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                if (activeInput.form) {
                  if (typeof activeInput.form.requestSubmit === 'function') {
                    activeInput.form.requestSubmit();
                  } else {
                    activeInput.form.submit();
                  }
                }
                hideOverlay(1000);
              } else {
                showOverlay('Speech not detected. دوبارہ کوشش کریں');
                hideOverlay(1000);
              }
              pendingTranscript = '';
              if (activeButton) {
                activeButton.classList.remove('active');
                activeButton.disabled = false;
              }
            });

            return recognition;
          }

          voiceButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
              event.preventDefault();
              var targetSelector = button.getAttribute('data-target');
              var input = document.querySelector(targetSelector);
              if (!input) { return; }

              activeButton = button;
              activeInput = input;

              try {
                var recognitionInstance = ensureRecognition();
                recognitionInstance.abort();
                button.classList.add('active');
                button.disabled = true;
                showOverlay('Listening… بول کر سرچ کریں');

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                  navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                      stream.getTracks().forEach(function(track) { track.stop(); });
                      recognitionInstance.start();
                    })
                    .catch(function(err) {
                      console.error('Mic permission denied', err);
                      showOverlay('Mic blocked. براہ مہربانی اجازت دیں');
                      hideOverlay(1000);
                      button.classList.remove('active');
                      button.disabled = false;
                    });
                } else {
                  recognitionInstance.start();
                }
              } catch (err) {
                console.error('Voice search init failed', err);
                showOverlay('Voice search not available in this browser.');
                button.classList.add('d-none');
                hideOverlay(1000);
              }
            });
          });

          voiceInitDone = true;
        }

        document.addEventListener('turbo:load', initVoiceSearch);
        document.addEventListener('DOMContentLoaded', initVoiceSearch);
        document.addEventListener('turbo:load', function() {
          var existingOverlay = document.getElementById('voice-overlay');
          if (existingOverlay) { existingOverlay.classList.add('d-none'); }
        });
      })();
    </script>
  </body>
</html>
